name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Run tests
      run: npm test -- --watchAll=false --passWithNoTests --coverage
      env:
        CI: true
    
    - name: Upload test coverage
      uses: actions/upload-artifact@v3
      with:
        name: test-coverage-${{ github.run_number }}
        path: coverage/
        retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Build application
      run: npm run build
      env:
        CI: false
    
    - name: Create build metadata
      run: |
        mkdir -p build/metadata
        echo "{" > build/metadata/build-info.json
        echo "  \"buildNumber\": \"${{ github.run_number }}\"," >> build/metadata/build-info.json
        echo "  \"commitSha\": \"${{ github.sha }}\"," >> build/metadata/build-info.json
        echo "  \"branch\": \"${{ github.ref_name }}\"," >> build/metadata/build-info.json
        echo "  \"buildDate\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> build/metadata/build-info.json
        echo "  \"repository\": \"${{ github.repository }}\"" >> build/metadata/build-info.json
        echo "}" >> build/metadata/build-info.json
    
    - name: Archive build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: shopizer-react-build-${{ github.run_number }}
        path: build/
        retention-days: 90
    
    - name: Create release package
      run: |
        tar -czf shopizer-react-${{ github.run_number }}.tar.gz -C build .
    
    - name: Upload release package
      uses: actions/upload-artifact@v3
      with:
        name: shopizer-react-release-${{ github.run_number }}
        path: shopizer-react-${{ github.run_number }}.tar.gz
        retention-days: 90

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t shopizer-shop-reactjs:${{ github.run_number }} .
        docker tag shopizer-shop-reactjs:${{ github.run_number }} shopizer-shop-reactjs:latest
    
    - name: Save Docker image
      run: |
        docker save shopizer-shop-reactjs:${{ github.run_number }} | gzip > shopizer-react-docker-${{ github.run_number }}.tar.gz
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v3
      with:
        name: shopizer-react-docker-${{ github.run_number }}
        path: shopizer-react-docker-${{ github.run_number }}.tar.gz
        retention-days: 30
